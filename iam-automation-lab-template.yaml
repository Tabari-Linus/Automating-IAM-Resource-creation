AWSTemplateFormatVersion: "2010-09-09"
Description: >
  Automating creation of IAM resources for lab:
  - Generates a one-time password in AWS Secrets Manager
  - Creates S3 and EC2 read-only IAM groups
  - Creates two IAM users with console access, assigns groups, and forces password change on first login.

Metadata:
  Source: "Lab helper template"
  GithubHint: "Save this file as iam-lab-template.yaml in your repo"

Resources:
  OneTimePasswordSecret:
    Type: AWS::SecretsManager::Secret
    Properties:
      Name: !Sub "${AWS::StackName}-OneTimePassword-${AWS::Region}-${AWS::AccountId}"
      Description: Auto-generated one-time password for IAM users
      GenerateSecretString:
        SecretStringTemplate: '{"password": ""}'
        GenerateStringKey: password
        PasswordLength: 12
        ExcludeCharacters: '"@/\'
        RequireEachIncludedType: true

  S3UserGroup:
    Type: AWS::IAM::Group
    Properties:
      GroupName: !Sub "${AWS::StackName}-S3ReadGroup"
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/AmazonS3ReadOnlyAccess

  EC2UserGroup:
    Type: AWS::IAM::Group
    Properties:
      GroupName: !Sub "${AWS::StackName}-EC2ReadGroup"
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/AmazonEC2ReadOnlyAccess

  S3IAMUser:
    Type: AWS::IAM::User
    Properties:
      UserName: !Sub "${AWS::StackName}-s3-user"
      Groups:
        - !Ref S3UserGroup
      LoginProfile:
        Password:
          Fn::Sub: "{{resolve:secretsmanager:${OneTimePasswordSecret}:SecretString:password}}"
        PasswordResetRequired: true

  EC2IAMUser:
    Type: AWS::IAM::User
    Properties:
      UserName: !Sub "${AWS::StackName}-ec2-user"
      Groups:
        - !Ref EC2UserGroup
      LoginProfile:
        Password:
          Fn::Sub: "{{resolve:secretsmanager:${OneTimePasswordSecret}:SecretString:password}}"
        PasswordResetRequired: true

Outputs:
  S3User:
    Description: "S3 Read-only user name"
    Value: !Ref S3IAMUser
  EC2User:
    Description: "EC2 Read-only user name"
    Value: !Ref EC2IAMUser
  SecretARN:
    Description: "Secret containing initial password"
    Value: !Ref OneTimePasswordSecret